<body class="sub_page">
  <!-- about section -->
  <section class="about_section layout_padding">
    <div class="about_container">
      <div class="sideSocket">
        <p id="socket" class="socket"></p>
      </div>
      <div class="d-flex justify-content-center">
        <h2 class="custom_heading">캠프 예약안내</h2>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">캠프</th>
            <th scope="col">기본가</th>
            <th scope="col">유형</th>
            <th scope="col">기준인원 초과요금</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">칼날부리, 늑대, 두꺼비, 작은골렘</th>
            <td>50000</td>
            <td>type : 1</td>
            <td>10000</td>
          </tr>
          <tr>
            <th scope="row">블루골렘, 레드골렘</th>
            <td>100000</td>
            <td>type : 2</td>
            <td>15000</td>
          </tr>
          <tr>
            <th scope="row">드래곤, 바론</th>
            <td>150000</td>
            <td>type : 3</td>
            <td>20000</td>
          </tr>
        </tbody>
      </table>
      <div class="guide">
        ※ 입실·퇴실 안내<br />
        입실 : 15:00 이후, 퇴실 : 11:00 이전 22시 이후 입실하실 경우 펜션으로<br />
        사전 연락 부탁드립니다.
      </div>
      <hr class="hr-solid" />
      <div class="table-wrap">
        <table id="testTable" class="select-camp">
          <tbody>
            <thead>
              <tr>
                <th>캠프</th>
                <th>가격</th>
                <th>타입</th>
                <th>캠프 이용 인원</th>
                <th>추가 이용 인원</th>
                <th>선택</th>
              </tr>
            </thead>
            <tr id="camp1" data-campname="red-blade">
              <td id="red-blade-name">칼날부리(Red)</td>
              <td id="red-blade-price">50,000</td>
              <td id="red-blade-type">1</td>
              <td>
                <input
                  type="number"
                  id="red-blade-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-blade-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp2" data-campname="red-wolf">
              <td id="red-wolf-name">늑대(Red)</td>
              <td id="red-wolf-price">50,000</td>
              <td id="red-wolf-type">1</td>
              <td>
                <input
                  type="number"
                  id="red-wolf-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-wolf-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp3" data-campname="red-toad">
              <td id="red-toad-name">두꺼비(Red)</td>
              <td id="red-toad-price">50,000</td>
              <td id="red-toad-type">1</td>
              <td>
                <input
                  type="number"
                  id="red-toad-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-toad-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp4" data-campname="red-golem">
              <td id="red-golem-name">작은골렘(Red)</td>
              <td id="red-golem-price">50,000</td>
              <td id="red-golem-type">1</td>
              <td>
                <input
                  type="number"
                  id="red-golem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-golem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp5" data-campname="red-blueGolem">
              <td id="red-blueGolem-name">블루골렘(Red)</td>
              <td id="red-blueGolem-price">100,000</td>
              <td id="red-blueGolem-type">2</td>
              <td>
                <input
                  type="number"
                  id="red-blueGolem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-blueGolem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp6" data-campname="red-redGolem">
              <td id="red-redGolem-name">레드골렘(Red)</td>
              <td id="red-redGolem-price">100,000</td>
              <td id="red-redGolem-type">2</td>
              <td>
                <input
                  type="number"
                  id="red-redGolem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="red-redGolem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp7" data-campname="blue-blade">
              <td id="blue-blade-name">칼날부리(Blue)</td>
              <td id="blue-blade-price">50,000</td>
              <td id="blue-blade-type">1</td>
              <td>
                <input
                  type="number"
                  id="blue-blade-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-blade-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp8" data-campname="blue-wolf">
              <td id="blue-wolf-name">늑대(Blue)</td>
              <td id="blue-wolf-price">50,000</td>
              <td id="blue-wolf-type">1</td>
              <td>
                <input
                  type="number"
                  id="blue-wolf-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-wolf-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp9" data-campname="blue-toad">
              <td id="blue-toad-name">두꺼비(Blue)</td>
              <td id="blue-toad-price">50,000</td>
              <td id="blue-toad-type">1</td>
              <td>
                <input
                  type="number"
                  id="blue-toad-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-toad-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp10" data-campname="blue-golem">
              <td id="blue-golem-name">작은골렘(Blue)</td>
              <td id="blue-golem-price">50,000</td>
              <td id="blue-golem-type">1</td>
              <td>
                <input
                  type="number"
                  id="blue-golem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-golem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp11" data-campname="blue-blueGolem">
              <td id="blue-blueGolem-name">블루골렘(Blue)</td>
              <td id="blue-blueGolem-price">100,000</td>
              <td id="blue-blueGolem-type">2</td>
              <td>
                <input
                  type="number"
                  id="blue-blueGolem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-blueGolem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp12" data-campname="blue-redGolem">
              <td id="blue-redGolem-name">레드골렘(Blue)</td>
              <td id="blue-redGolem-price">100,000</td>
              <td id="blue-redGolem-type">2</td>
              <td>
                <input
                  type="number"
                  id="blue-redGolem-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="blue-redGolem-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp13" data-campname="dragon">
              <td id="dragon-name">드래곤</td>
              <td id="dragon-price">150,000</td>
              <td id="dragon-type">3</td>
              <td>
                <input
                  type="number"
                  id="dragon-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="dragon-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
            <tr id="camp14" data-campname="baron">
              <td id="baron-name">바론</td>
              <td id="baron-price">150,000</td>
              <td id="baron-type">3</td>
              <td>
                <input
                  type="number"
                  id="baron-people"
                  min="1"
                  max="4"
                  value="1"
                />
              </td>
              <td>
                <input
                  type="number"
                  id="baron-additionalUsers"
                  min="0"
                  max="4"
                  value="0"
                />
              </td>
              <td>
                <button class="select" onclick="selectItem(this)">선택</button>
              </td>
            </tr>
          </tbody>
        </table>
        <hr class="hr-solid" />
        <div id="payment-info" class="paymentInfo">
          <div class="d-flex justify-content-center">
            <h2 class="custom_heading">내가 선택한 캠프 확인</h2>
          </div>
          <p>캠프명 : <span id="camp-name"></span></p>
          <p>캠프 가격 : <span id="camp-price"></span></p>
          <p>총 인원 : <span id="total-people"></span></p>
          <p>총 가격 : <span id="total-price"></span></p>
        </div>
      </div>
      <button onclick="goingToPay()" class="payment-btn">결제하러 가기</button>
    </div>
  </section>
</body>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    disableUsedCamps();
  });

  // 이미 예약된 캠프를 비활성화하는 함수
  function disableUsedCamps() {
    // 로컬 스토리지에서 사용된 캠프를 가져옴
    const usedCamps = JSON.parse(localStorage.getItem('usedCamps'));
    // 사용된 캠프를 모두 비활성화 하는 반복문
    usedCamps.forEach((camp) => {
      const campRow = document.getElementById(`camp${camp}`);
      campRow.disabled = true;
      campRow.classList.add('disabled');
      // input과 button 요소를 모두 비활성화
      campRow
        .querySelectorAll('input, button')
        .forEach((item) => (item.disabled = true));
    });
  }

  // 유저가 선택 버튼을 눌렀을 때, 해당 정보를 아래에 업데이트하는 함수
  function selectItem(button) {
    const camp = button.closest('tr');
    const dataCampName = camp.dataset.campname;
    const campName = document.getElementById(`${dataCampName}-name`).innerHTML;
    // number 타입으로 사용하길 상정했던 텍스트나 밸류값을 Number타입으로 변수에 담음
    const campPrice = Number(
      document
        .getElementById(`${dataCampName}-price`)
        .innerHTML.replace(/,/g, ''),
    );
    const campType = Number(
      document.getElementById(`${dataCampName}-type`).innerHTML,
    );
    const numOfPeople = Number(
      document.getElementById(`${dataCampName}-people`).value,
    );
    const numOfAdditionalUsers = Number(
      document.getElementById(`${dataCampName}-additionalUsers`).value,
    );

    if (`${numOfPeople}` < 4 && `${numOfAdditionalUsers}` >= 1)
      throw new Error(
        (status = 400),
        alert('초과 인원은 캠프 기본 할당 인원을 모두 채워야 이용 가능합니다'),
      );

    const fields = {
      'camp-name': campName,
      'camp-price': campPrice,
      'total-people': numOfPeople + numOfAdditionalUsers,
      'total-price': campPrice,
    };

    // 추가인원이 1명 이상일 때
    if (numOfAdditionalUsers >= 1) {
      // 추가 요금을 계산한다. (추가인원 x 캠프 타입에 따른 가격)
      let additionalAmount =
        numOfAdditionalUsers *
        (campType === 1 ? 10000 : campType === 2 ? 15000 : 20000);
      // 캠핑장 가격과 추가 요금을 더한 값을 'total-price' 필드에 저장한다.
      fields['total-price'] = campPrice + additionalAmount;
    } else {
      // 계산된 총 금액을 'total-price' 필드에 저장한다.
      fields['total-price'] = campPrice;
    }
    // fields 객체의 각 필드와 값을 반복하여 HTML 요소에 출력함.
    for (const [field, value] of Object.entries(fields)) {
      document.getElementById(field).innerHTML = value;
    }
  }

  // 결제 페이지로 이동하는 함수
  function goingToPay() {
    const campName = document.getElementById('camp-name').innerHTML;
    const totalPeople = Number(
      document.getElementById('total-people').innerHTML,
    );
    const totalPrice = Number(document.getElementById('total-price').innerHTML);
    const selectedDay = document.location.pathname.split('/')[3];

    const fields = {
      campName,
      totalPeople,
      totalPrice,
      selectedDay,
    };

    if (!fields.campName || !fields.totalPeople || !fields.totalPrice)
      throw new Error(
        alert('먼저 원하시는 캠프를 선택해 주십시오.'),
        (status = 400),
      );

    localStorage.setItem('paymentInfo', JSON.stringify(fields));

    window.location.href = '/view/payment';
  }

  // 소켓 접속
  const reserveDay = '<%- day %>';
  const socket = io('<%- socketReserve %>', {
    query: {
      day: reserveDay,
    },
  });

  // 소켓 통신
  socket.on(reserveDay, (data) => {
    document.querySelector(
      '#socket',
    ).textContent = `같은 날짜에 예약중인 유저 수 : 총 ${data}명`;
  });
</script>
